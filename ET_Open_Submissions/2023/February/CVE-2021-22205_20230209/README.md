# ET Open Submission
### February 9th, 2023
### GitLab Pre-Auth RCE (CVE-2021-22205)


## Resources

1. https://github.com/vulhub/vulhub/tree/master/gitlab/CVE-2021-22205
2. https://hackerone.com/reports/1154542
3. https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html

Below is the POST request from my own testing that I based the signature on.

```POST /uploads/user HTTP/1.1
Host: 192.168.2.16:8080
User-Agent: python-requests/2.28.1
Accept-Encoding: gzip, deflate, br
Accept: */*
Connection: keep-alive
X-CSRF-Token: VR9uMPrEVMwWOUqfWEwPwjQ4HjwKNsrNn+L5c5hqXnVY+/0S9ERFPizLVu+0nsDy23E8MqM2JNwNltged71LWA==
Cookie: _gitlab_session=e85fa540d01aefa35fdb91be6c4cd125; experimentation_subject_id=eyJfcmFpbHMiOnsibWVzc2FnZSI6IkltWXhNakpqWVdabExUWTVaalV0TkRJek1DMDRNalJoTFdKak4yWTNNREUyT1RJd1lTST0iLCJleHAiOm51bGwsInB1ciI6ImNvb2tpZS5leHBlcmltZW50YXRpb25fc3ViamVjdF9pZCJ9fQ%3D%3D--db3a8e93a43c3a42e5c8b893e386889c13204189
Content-Length: 283
Content-Type: multipart/form-data; boundary=7104df47dbcffa3c3138a20208e377d6

--7104df47dbcffa3c3138a20208e377d6
Content-Disposition: form-data; name="file"; filename="test.jpg"
Content-Type: image/jpeg

AT&TFORM...eDJVUINFO...
......,...BGjp....ANTa...?(metadata
	(Copyright "\
" . qx{touch /tmp/test} . \
" b ") )

--7104df47dbcffa3c3138a20208e377d6--
```

The exploit will always be a POST

The /uploads/user API is what is vulnerable here so it will always be present.

CSRF token is required to hit the API so this will always be present.

The part I am having the most trouble with is the request body. Mostly the actual code being injected.

```
AT&TFORM...eDJVUINFO...
......,...BGjp....ANTa...?(metadata
	(Copyright "\
" . qx{touch /tmp/test} . \
" b ") )
```

I have seen this part change slightly in different writeups and POCs like below.

```
AT&TFORM....DJVUANTa....(metadata.
(Author "\.". return `date`; #")
```

And here:

![image](https://user-images.githubusercontent.com/43767555/217961959-cd3b4c51-ff83-40cb-86cd-1cb4b8a93f85.png)

What I do know is the AT&TFORM and the ```(metadata``` seem to always be present.

## Signature

I have most of a sig ready but I am not entirely sure how to detect for linux code other than the shellcode metacharacters PCRE which doesn't even need to be used in this exploit anyway.

```alert http $EXTERNAL_NET any -> $HOME_NET any msg:"ET Exploit (GitLab Pre-Auth RCE Detected)"; flow:established,to_server; http.method; content:"POST"; bsize:4; http.uri; content:"/uploads/user"; startswith; bsize:13; http.header_names; content:"|0d 0a|X|2d|CSRF|2d|Token|0d 0a|"; content:"|0d 0a|Content|2d|Length|0d 0a|"; content:"|0d 0a|Content|2d|Type|0d 0a|"; http.request_body; content:"|0d 0a|Content|2d|Disposition|3a 20|"; offset:34; content:"form|2d|data|3b 20|"; content:"name|3d 22|"; content:"filename|3d 22|"; content:"Content|2d|Type|3a 20|image|2f|"; content:"|0d 0a 0d 0a|AT|26|TFORM"; within:25; content:"|28|metadata"; distance:30; within:70;  reference:url,https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html; classtype:exploit-activity; sid:1; rev:1;)```


[Dalton Job ID](https://dalton.centraliowacybersec.com/dalton/coverage/job/cbd8ea3583791068)

This link **should** last for 30 days. If not, just use the pcap to recreate it.

## Downloads

[Exploit PCAP](exploit.pcapng)
